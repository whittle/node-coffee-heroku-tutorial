
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Headers and encodings: being a good web citizen - Node && CoffeeScript && Heroku</title>
  <meta name="author" content="Jason Whittle">

  
  <meta name="description" content="So, in the last post we sent our very first message, but we’re notquite doing everything we should.RFC 2616 §14.13,specifies that our server should...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://whittle.github.com/node-coffee-heroku-tutorial/blog/2011/10/19/headers-and-encodings-being-a-good-web-citizen/">
  <link href="/node-coffee-heroku-tutorial/favicon.png" rel="icon">
  <link href="/node-coffee-heroku-tutorial/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/node-coffee-heroku-tutorial/javascripts/modernizr-2.0.js"></script>
  <script src="/node-coffee-heroku-tutorial/javascripts/ender.js"></script>
  <script src="/node-coffee-heroku-tutorial/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/node-coffee-heroku-tutorial/atom.xml" rel="alternate" title="Node && CoffeeScript && Heroku" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/node-coffee-heroku-tutorial/">Node && CoffeeScript && Heroku</a></h1>
  
    <h2>A (Mildly Obsessive) Tutorial</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/node-coffee-heroku-tutorial/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:whittle.github.com/node-coffee-heroku-tutorial" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/node-coffee-heroku-tutorial/">Blog</a></li>
  <li><a href="/node-coffee-heroku-tutorial/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Headers and Encodings: Being a Good Web Citizen</h1>
    
    
      <p class="meta">
        




  

<time datetime="2011-10-19T16:00:00-04:00" pubdate>19 Oct 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>So, in the last post we sent our very first message, but we’re not
quite doing everything we should.</p>

<p><a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">RFC 2616 §14.13</a>,
specifies that our server should be sending a <code>Content-Length</code> header
with the size of the body in octects (8-bit bytes). Fortunately,
Node can figure that out for us:</p>

<div><script src='http://gist-it.appspot.com/github/whittle/node-coffee-heroku-tutorial/raw/8811e6c46aa910ad71420591548f1bb4aaa644eb/app.js'></script>
<noscript><pre><code>(function() {
  var http = require('http');

  var say_hello = function(request, response) {
    var message = 'Hello, world!';

    response.setHeader('Content-Type', 'text/plain; charset=utf-8');
    response.setHeader('Content-Length', Buffer.byteLength(message, 'utf8'));
    response.write(message, 'utf8');
    response.end();
  };

  var app = http.createServer(say_hello);
  app.listen(3080);
})();
</code></pre></noscript></div>


<p>Here, we used
<a href="http://nodejs.org/docs/v0.4.8/api/buffers.html#buffer.byteLength"><code>Buffer.byteLength()</code></a>
to measure the number of bytes that are going to be sent. We also made
it explicit that we wanted to do all of this in
<a href="http://en.wikipedia.org/wiki/UTF-8">UTF-8</a>, although both <code>write()</code>
and <code>byteLength()</code> will default to UTF-8 if we specify nothing.</p>

<p>Because all of the characters in our <code>message</code> are in the ASCII
set—and can therefore be represented as single bytes in UTF-8—the
result of <code>byteLength()</code> in this case is the same as the result would
be for <code>message.length()</code>: 13. We can even prove this by including a
non-standard HTTP header:</p>

<div><script src='http://gist-it.appspot.com/github/whittle/node-coffee-heroku-tutorial/raw/4344892c97c1f4cea0a04e188ba71baf5916b631/app.js'></script>
<noscript><pre><code>(function() {
  var http = require('http');

  var say_hello = function(request, response) {
    var message = 'Hello, world!';

    response.setHeader('Content-Type', 'text/plain; charset=utf-8');
    response.setHeader('Content-Length', Buffer.byteLength(message, 'utf8'));
    response.setHeader('X-Content-Character-Count', message.length);
    response.write(message, 'utf8');
    response.end();
  };

  var app = http.createServer(say_hello);
  app.listen(3080);
})();
</code></pre></noscript></div>


<p>However, if we include anything besides the first 128 characters of the Unicode
character set, <code>message.length()</code> will no longer give us the correct
result:</p>

<div><script src='https://gist.github.com/1299915.js?file=app.js'></script>
<noscript><pre><code>(function() {
  var http = require('http');

  var say_hello = function(request, response) {
    var message = 'مرحبا العالم';

    response.setHeader('Content-Type', 'text/plain; charset=utf-8');
    response.setHeader('Content-Length', Buffer.byteLength(message, 'utf8'));
    response.setHeader('X-Content-Character-Count', message.length);
    response.write(message, 'utf8');
    response.end();
  };

  var app = http.createServer(say_hello);
  app.listen(3080);
})();
</code></pre></noscript></div>


<p>Here, the usual English message has been switched with its
<a href="http://www.howtosayin.com/say/arabic/hello+world.html">Arabic equivalent</a>,
which has 12 characters that occupy 23 bytes on the wire, and the
headers bear that out:</p>

<pre><code>HTTP/1.1 200 OK
Content-Type: text/plain; charset=utf-8
Content-Length: 23
X-Content-Character-Count: 12
Connection: keep-alive
</code></pre>

<p>Something important to note is the order that we’re calling methods on the
<a href="http://nodejs.org/docs/v0.4.12/api/http.html#http.ServerResponse"><code>http.ServerResponse</code></a>.
It is critical that all the headers have been set on the response
before ever calling
<a href="http://nodejs.org/docs/v0.4.12/api/http.html#response.write"><code>write()</code></a>,
because <code>write()</code> flushes the headers. Similarly,
<a href="http://nodejs.org/docs/v0.4.12/api/http.html#response.end"><code>end()</code></a>
signals that the headers and body are complete as is.</p>

<p>Constructing the response out-of-order is instructive, in that it
produces a number of distinct failure modes:</p>

<ul>
<li><p>Placing a <code>setHeader()</code> after a <code>write()</code> produces an exception with
the message “Can&#8217;t set headers after they are sent.” If the
exception is uncaught, it will crash the server.</p></li>
<li><p>Placing a <code>write()</code> after the <code>end()</code> causes that <code>write()</code> to never
get sent to the client.</p>

<ul>
<li>If the content-length header is too long for the actual content
sent (i.e., the <code>write()</code>s prior to the <code>end()</code>), the client will
stall as it waits for the server to send the missing bytes.</li>
</ul>
</li>
</ul>


<p>As we wrap things up, let’s shorten our code a little bit.
<a href="http://www.codinghorror.com/blog/2007/05/the-best-code-is-no-code-at-all.html">Much</a>
has
<a href="http://dev.af83.com/code-liability-not-asset-part-1-3/2010/02/24">been</a>
<a href="http://www.infoq.com/news/2011/05/less-code-is-better">said</a> about
keeping your code small, so I won’t harp on it:</p>

<div><script src='http://gist-it.appspot.com/github/whittle/node-coffee-heroku-tutorial/raw/5a37ea31b0846e8ce72d853db43d2a38babb04e3/app.js'></script>
<noscript><pre><code>(function() {
  var http = require('http');

  var sayHello = function(request, response) {
    var message = 'Hello, world!';

    response.writeHead(200, {
      'Content-Type': 'text/plain; charset=utf-8',
      'Content-Length': Buffer.byteLength(message, 'utf8')});
    response.end(message, 'utf8');
  };

  var app = http.createServer(sayHello);
  app.listen(3080);
})();
</code></pre></noscript></div>


<p>What we’ve done here (besides going back to English and removing the
non-standard character-count header) is to pack our remaining headers
into an object and pass them all together to
<a href="http://nodejs.org/docs/v0.4.12/api/http.html#response.writeHead"><code>ServerResponse.writeHead()</code></a>.
<code>writeHead()</code> also requires an
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP status code</a>
which should always be <code>200 OK</code> for now.</p>

<p>Additionally, the documentation for
<a href="http://nodejs.org/docs/v0.4.12/api/http.html#response.end"><code>end()</code></a>
specifies that as well as finalizing our response, we can also use it
as a last (and in this case only) <code>write()</code>.</p>

<p>All told, this only saves us two method calls, but if every time you
refactor it nets huge gains, maybe you don’t do it enough.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jason Whittle</span></span>

      




  

<time datetime="2011-10-19T16:00:00-04:00" pubdate>19 Oct 2011</time>
      

<span class="categories">
  
    <a class='category' href='/node-coffee-heroku-tutorial/blog/categories/javascript/'>javascript</a>, <a class='category' href='/node-coffee-heroku-tutorial/blog/categories/node/'>node</a>, <a class='category' href='/node-coffee-heroku-tutorial/blog/categories/utf8/'>utf8</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://whittle.github.com/node-coffee-heroku-tutorial/blog/2011/10/19/headers-and-encodings-being-a-good-web-citizen/" data-via="" data-counturl="http://whittle.github.com/node-coffee-heroku-tutorial/blog/2011/10/19/headers-and-encodings-being-a-good-web-citizen/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/node-coffee-heroku-tutorial/blog/2011/10/18/hello-world-a-first-node-app/" title="Previous Post: Hello world: a first node app">&laquo; Hello world: a first node app</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/node-coffee-heroku-tutorial/blog/2011/10/19/headers-and-encodings-being-a-good-web-citizen/">Headers and encodings: being a good web citizen</a>
      </li>
    
      <li class="post">
        <a href="/node-coffee-heroku-tutorial/blog/2011/10/18/hello-world-a-first-node-app/">Hello world: a first node app</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Jason Whittle -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
